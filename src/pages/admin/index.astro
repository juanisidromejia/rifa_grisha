---
import HeaderGrisha from "../../components/HeaderGrisha.astro";

// Lógica de protección: Si no hay cookie de sesión 'admin_session', redirige al login.
const isAuthenticated = Astro.cookies.has("admin_session");

// Asegúrate de que esta redirección solo ocurra si se está intentando acceder a /admin directamente.
// Si ya estás en /admin/login, no deberías redirigir de nuevo.
if (
    !isAuthenticated &&
    Astro.request.url.includes("/admin") &&
    !Astro.request.url.includes("/admin/login")
) {
    return Astro.redirect("/admin/login");
}
---

<html lang="en">
    <head>
        <meta charset="utf-8" />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <meta name="viewport" content="width=device-width" />
        <meta name="generator" content={Astro.generator} />
        <title>Rifa Grisha - Panel de Administración</title>
        <style>
            body {
                font-family: sans-serif;
                line-height: 1.6;
                margin: 0;
                padding: 0;
                background-color: #f4f4f4;
                color: #333;
            }
            main {
                max-width: 900px;
                margin: 50px auto;
                padding: 30px;
                background: #fff;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }
            h1 {
                color: #764ba2;
                font-size: 2.5rem;
                margin-bottom: 30px;
                text-align: center;
            }
            .dashboard-section {
                background-color: #eef4f9;
                padding: 20px;
                border-radius: 8px;
                margin-bottom: 20px;
            }
            .dashboard-section h2 {
                color: #667eea;
                margin-bottom: 15px;
            }
            .data-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 15px;
            }
            .data-table th,
            .data-table td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: left;
            }
            .data-table th {
                background-color: #667eea;
                color: white;
            }
            .data-table tr:nth-child(even) {
                background-color: #f2f2f2;
            }
            .logout-button {
                background-color: #dc3545;
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 1rem;
                margin-top: 20px;
                float: right;
            }
            .logout-button:hover {
                background-color: #c82333;
            }
            /* Login form styles (these will primarily be in admin/login.astro) */
            .login-container {
                max-width: 400px;
                margin: 100px auto;
                padding: 30px;
                background: #fff;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                text-align: center;
            }
            .login-container h2 {
                color: #764ba2;
                margin-bottom: 25px;
            }
            .login-container form {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }
            .login-container input[type="text"],
            .login-container input[type="password"] {
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
            }
            .login-container button {
                background-color: #764ba2;
                color: white;
                padding: 10px 15px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }
            .login-container button:hover {
                background-color: #6a3e90;
            }
            .login-message {
                margin-top: 15px;
                padding: 10px;
                border-radius: 4px;
                background-color: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
                display: none;
            }
        </style>
    </head>
    <body>
        <HeaderGrisha />
        <main>
            <button id="logout-button" class="logout-button"
                >Cerrar Sesión</button
            >
            <h1>Panel de Administración Rifa Grisha</h1>

            <section class="dashboard-section">
                <h2>Resumen de Registros</h2>
                <p>
                    Aquí se mostrará un resumen de los usuarios registrados y su
                    estado.
                </p>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Correo</th>
                            <th>Estado</th>
                            <th>Números Rifa</th>
                            <th>Registro</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="user-list">
                        <!-- Los datos de los usuarios se cargarán aquí -->
                        <tr>
                            <td>...</td>
                            <td>...</td>
                            <td>...</td>
                            <td>...</td>
                            <td>...</td>
                            <td
                                >...
                                <button>Confirmar Pago</button>
                                <button>Enviar Rifas</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <section class="dashboard-section">
                <h2>Estadísticas Rápidas</h2>
                <p>Número total de registros, verificados, pagos, etc.</p>
            </section>
        </main>
        <script is:inline>
            document
                .getElementById("logout-button")
                .addEventListener("click", async () => {
                    try {
                        const response = await fetch("/api/admin/logout", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                        });

                        const data = await response.json();

                        if (response.ok && data.success) {
                            alert(data.message || "Sesión cerrada.");
                            window.location.href = "/admin/login";
                        } else {
                            alert(data.message || "Error al cerrar sesión.");
                        }
                    } catch (error) {
                        console.error(
                            "Error al intentar cerrar sesión:",
                            error,
                        );
                        alert("Ocurrió un error de conexión al cerrar sesión.");
                    }
                });
        </script>
    </body>
</html>
